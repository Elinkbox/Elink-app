<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Linkbox License Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #333333;
      color: #ecf0f1;
      display: flex;
      flex-direction: column;
      font-size: 16px;
      min-height: 100vh;  /* Ensures body occupies full viewport height */
      overflow-y: auto;  /* Allow body to scroll */
    }
    
    .logo-container {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 20px;
    }
    
    .logo {
      height: 50px;
      width: auto;
      margin-left: 20px;
    }
    
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: -10px;
      padding-bottom: 20px;
    }
    
    h1 {
      color: #ecf0f1;
      font-size: 28px;
      margin-top: 10px;
      text-align: center;
    }
    
    button {
      cursor: pointer;
      border: none;
      padding: 10px 20px;
      color: #fff;
      border-radius: 4px;
      transition: background-color 0.3s, transform 0.2s ease;
      font-size: 16px;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    .container {
     
      flex-direction: column;
      flex-grow: 1;
      padding: 15px;
      overflow-y: auto; /* Allow content inside container to scroll */
    }
    
    .table-container {
      height: calc(100vh - 250px); /* Adjust the value (200px) based on the total height of other elements */
      overflow-y: auto;
      flex-grow: 1;
    }
    
    
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #444444;
    }
    
    th, td {
      padding: 10px;
      text-align: center;
      vertical-align: middle;
      border-bottom: 1px solid #333;
      font-size: 16px;
    }
    
    th {
      background-color: #58595b;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .enabled-btn {
      background-color: #4CAF50;
      margin: 0 auto;
    }
    
    .disabled-btn {
      background-color: #f44336;
      margin: 0 auto;
    }
    
    .delete-btn {
      color: #f44336;
      margin: 0 auto;
    }
    
    .enabled-status {
      color: #4CAF50;
    }
    
    .disabled-status {
      color: #f44336;
    }
    
    #addDeviceBtn {
      background-color: #ffbf00;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    #addDeviceBtn:hover {
      background-color: #ffbf00;
    }
    
    #logoutBtn {
      background-color: #dc3545;
      margin-top: 20px;
      font-size: 18px;
    }
    
    #logoutBtn:hover {
      background-color: #c82333;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: #444444;
      color: #fff;
      padding: 20px;
      border-radius: 6px;
      text-align: center;
      font-size: 18px;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }
    
    .modal-buttons button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 16px;
    }
    
    .cancel-btn {
      background-color: #f44336;
    }
    
    .confirm-btn {
      background-color: #4CAF50;
    }
    
    .button-container {
      display: flex;
      gap: 10px;
    }
    
    td input {
      padding: 5px;
      font-size: 14px;
    }
    
    .save-btn {
      background-color: #28a745;
    }
    
    .cancel-edit-btn {
      background-color: #dc3545;
    }
    
    td .editable {
      cursor: pointer;
      border-bottom: 1px dashed transparent;
      transition: border-bottom 0.3s;
    }
    
    td .editable:hover {
      border-bottom: 1px dashed #ecf0f1;
    }
    
    td .editable:after {
      color: #7f8c8d;
      font-size: 12px;
      margin-left: 5px;
      visibility: hidden;
    }
    
    td .editable:hover:after {
      visibility: visible;
    }
    
    @media (max-width: 768px) {
      body {
        font-size: 14px; /* Smaller font size for mobile devices */
      }
    
      .logo {
        height: 40px;
      }
    
      h1 {
        font-size: 24px; /* Adjust title font size */
      }
    
      .container {
        padding: 10px; /* Reduced padding for small screens */
        height: auto;
      }
    
      .table-container {
        max-height: 500px; /* Reduce max-height for smaller screens */
      }
    
      table th, table td {
        padding: 8px; /* Reduced padding for better responsiveness */
        font-size: 14px; /* Adjust font size */
      }
    
      button {
        padding: 8px 15px; /* Smaller buttons on mobile */
        font-size: 14px; /* Adjust button font size */
      }
    
      #addDeviceBtn, #logoutBtn {
        width: 100%; /* Full width buttons on mobile */
        font-size: 16px;
      }
    
      .button-container {
        flex-direction: column; /* Stack buttons vertically on mobile */
      }
    
      td .editable {
        font-size: 12px; /* Smaller font for editable fields */
      }
    }
    
  </style>
</head>
<body>
  <div class="logo-container">
    <img src="logo.png" alt="Logo" class="logo">
  </div>

  <div class="header">
    <h1>Linkbox License Management</h1>
  </div>

  <div class="container">
    <button id="addDeviceBtn">Add Device</button>
    <!-- Logout Button -->
    <button id="logoutBtn">Logout</button>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Device ID</th>
            <th>Created At</th>
            <th>License</th>
            <th>Last Action</th>
            <th>Expiration Date</th> <!-- New column header -->
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="deviceList"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal for confirmation -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <h3 id="modalMessage">Are you sure?</h3>
      <div class="modal-buttons">
        <button class="cancel-btn" id="cancelBtn">Cancel</button>
        <button class="confirm-btn" id="confirmBtn">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    const apiUrl = 'http://localhost:3000';
    let currentDeviceId = null;
    let currentAction = null;
    
    function formatDate(dateString) {
      // Simply return the date as it is since it's already in the desired format
      return dateString;
    }
        

    async function fetchDevices() {
      const response = await fetch(`${apiUrl}/devices`);
      const devices = await response.json();
      const deviceList = document.getElementById('deviceList');
      deviceList.innerHTML = '';

      devices.forEach(device => {
        const createdAt = formatDate(device.timestamp);
        const lastAction = device.license === 'enabled' ? 
          `Enabled at: ${formatDate(device.enabledAt)}` : 
          `Disabled at: ${formatDate(device.disabledAt)}`;
        
        const expirationDate = device.expirationDate ? formatDate(device.expirationDate) : 'N/A';

        const row = document.createElement('tr');
        row.innerHTML = ` 
          <td>
            <span id="name-${device.deviceId}" class="editable" ondblclick="editName('${device.deviceId}')">
              ${device.name || 'Unnamed'}
            </span>
            <button class="save-btn" style="display:none;" id="save-${device.deviceId}" onclick="saveName('${device.deviceId}')">Save</button>
            <button class="cancel-edit-btn" style="display:none;" id="cancel-${device.deviceId}" onclick="cancelEdit('${device.deviceId}', '${device.name || 'Unnamed'}')">Cancel</button>
          </td>
          <td>${device.deviceId}</td>
          <td>${createdAt}</td>
          <td class="${device.license === 'enabled' ? 'enabled-status' : 'disabled-status'}">${device.license}</td>
          <td>${lastAction}</td>
          <td>${expirationDate}</td> <!-- New Expiration Date column -->
          <td>
            <div class="button-container">
              <button class="action-btn ${device.license === 'enabled' ? 'disabled-btn' : 'enabled-btn'}" onclick="toggleLicense('${device.deviceId}')">
                ${device.license === 'enabled' ? 'Disable' : 'Enable'}
              </button>
              <button class="delete-btn" onclick="confirmDeleteDevice('${device.deviceId}')">Delete</button>
            </div>
          </td>
        `;
        deviceList.appendChild(row);
      });
    }

    async function logout() {
      const response = await fetch(`${apiUrl}/logout`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });

      if (response.ok) {
        // Redirect the user to the login page
        window.location.href = '/index.html'; // Adjust the URL to your login page
      } else {
        alert('Logout failed');
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', logout);

    function editName(deviceId) {
      const nameSpan = document.getElementById(`name-${deviceId}`);
      const currentName = nameSpan.textContent;
      nameSpan.innerHTML = `<input type="text" id="input-${deviceId}" value="${currentName}" />`;
      document.getElementById(`save-${deviceId}`).style.display = 'inline';
      document.getElementById(`cancel-${deviceId}`).style.display = 'inline';
    }

    async function saveName(deviceId) {
      const input = document.getElementById(`input-${deviceId}`);
      const newName = input.value;

      const response = await fetch(`${apiUrl}/devices/${deviceId}/name`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newName }),
      });

      if (response.ok) {
        fetchDevices();
      } else {
        alert('Error updating name');
      }
    }

    function cancelEdit(deviceId, originalName) {
      const nameSpan = document.getElementById(`name-${deviceId}`);
      nameSpan.innerHTML = originalName || 'Unnamed';
      document.getElementById(`save-${deviceId}`).style.display = 'none';
      document.getElementById(`cancel-${deviceId}`).style.display = 'none';
    }

    async function addDevice() {
      const response = await fetch(`${apiUrl}/devices`, { method: 'POST' });
      if (response.ok) {
        fetchDevices();
      }
    }

    async function toggleLicense(deviceId) {
      const response = await fetch(`${apiUrl}/devices/${deviceId}/toggle`, { method: 'PUT' });
      if (response.ok) {
        fetchDevices();
      }
    }

    async function deleteDevice(deviceId) {
      const response = await fetch(`${apiUrl}/devices/${deviceId}`, { method: 'DELETE' });
      if (response.ok) {
        fetchDevices();
      }
    }

    function confirmDeleteDevice(deviceId) {
      currentDeviceId = deviceId;
      currentAction = 'delete';
      document.getElementById('modalMessage').innerText = 'Are you sure you want to delete this device?';
      document.getElementById('confirmationModal').style.display = 'flex';
    }

    document.getElementById('addDeviceBtn').addEventListener('click', () => {
      currentAction = 'add';
      document.getElementById('modalMessage').innerText = 'Are you sure you want to add a new device?';
      document.getElementById('confirmationModal').style.display = 'flex';
    });

    document.getElementById('confirmBtn').addEventListener('click', async () => {
      if (currentAction === 'delete') {
        deleteDevice(currentDeviceId);
      } else if (currentAction === 'add') {
        addDevice();
      }
      closeModal();
    });

    document.getElementById('cancelBtn').addEventListener('click', () => closeModal());

    function closeModal() {
      currentDeviceId = null;
      currentAction = null;
      document.getElementById('confirmationModal').style.display = 'none';
    }

    fetchDevices();
  </script>
</body>
</html>
